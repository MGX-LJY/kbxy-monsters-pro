# scripts/stop-bg.sh

## 概述
后台进程停止脚本，用于优雅地终止开发环境中运行的后端和前端服务。提供智能进程管理，支持PID文件和端口双重检测，确保进程完全清理。

## 核心功能

### 进程管理策略
- **双重检测**: 通过PID文件和端口占用两种方式确保进程彻底停止
- **进程树清理**: 递归终止子进程，避免孤儿进程
- **优雅停止**: 先发送TERM信号，失败后使用KILL信号强制终止

## 关键函数

### kill_tree()
**功能**: 递归终止整个进程树
**参数**: 
- `$1`: 父进程PID
**逻辑**:
1. 检查进程是否存在
2. 查找所有子进程(pgrep -P)
3. 递归终止每个子进程
4. 最后终止父进程

### wait_gone()
**功能**: 等待进程完全消失
**参数**:
- `$1`: 检查命令字符串
**行为**: 最多重试10次，每次间隔0.5秒

### stop_by_pidfile()
**功能**: 通过PID文件停止进程
**参数**:
- `$1`: 服务名称
**处理逻辑**:
1. 读取`$LOG_DIR/$name.pid`文件
2. 验证PID是否有效
3. 使用kill_tree()优雅终止
4. 失败时强制终止进程组(`kill -9 -$pid`)
5. 清理PID文件

### stop_by_port()
**功能**: 通过端口占用停止进程
**参数**:
- `$1`: 服务描述
- `$2`: 端口号
**处理逻辑**:
1. 使用lsof查找占用端口的进程
2. 先发送TERM信号优雅终止
3. 等待进程消失
4. 失败时使用KILL信号强制终止

### stop_one()
**功能**: 综合停止策略
**参数**:
- `$1`: 服务名称
- `$2`: 端口号(可选)
**策略**: 先按PID文件停止，再按端口兜底检查

## 环境配置

### 路径变量
- **ROOT**: 项目根目录，默认硬编码路径，可通过环境变量覆盖
- **LOG_DIR**: 日志和PID文件目录，默认`$ROOT/.logs`

### 脚本设置
- **set -euo pipefail**: 严格错误处理模式
- **错误即停**: 任何命令失败即退出
- **未定义变量检查**: 使用未定义变量时报错
- **管道错误传播**: 管道中任一命令失败整体失败

## 执行流程

### 服务停止顺序
1. **后端服务**: 停止端口8000上的backend进程
2. **前端服务**: 停止端口5173上的frontend进程

### 特殊处理
- **前端服务**: 加强端口检查，解决"父死子存活"问题
- **后端服务**: 主要依赖PID文件，端口作为兜底

## 安全特性

### 错误处理
- **容错设计**: 各个停止操作独立，失败不影响其他服务
- **资源清理**: 确保PID文件在进程终止后被删除
- **进程验证**: 终止前验证进程确实存在

### 信号处理
- **优雅终止**: 优先使用TERM信号
- **强制终止**: TERM失败后使用KILL信号
- **进程组清理**: 处理复杂的进程层次结构

## 使用场景

### 开发环境管理
- **服务重启**: 配合start-bg.sh实现服务重启
- **环境清理**: 开发完成后清理后台进程
- **端口释放**: 确保端口完全释放以便重新启动

### CI/CD集成
- **自动化测试**: 测试完成后清理环境
- **部署准备**: 部署前确保进程完全停止

这个脚本提供了可靠的进程管理机制，确保开发环境中的服务能够完全、干净地停止。