# scripts/start-bg.sh

## 概述
后台进程启动脚本，用于在开发环境中自动启动FastAPI后端服务和React前端服务。提供交互式环境选择、智能包管理器检测、虚拟环境激活和进程管理功能。

## 核心功能

### 环境管理
- **交互式环境选择**: 用户可选择dev或test环境
- **环境文件加载**: 自动加载`.env.<env>`配置文件
- **虚拟环境激活**: 自动检测并激活Python虚拟环境

### 进程管理
- **PID文件管理**: 使用PID文件跟踪后台进程状态
- **重复启动检测**: 防止同一服务多次启动
- **后台运行**: 服务以nohup方式在后台持续运行

## 环境配置

### 路径变量
- **ROOT**: 项目根目录，默认硬编码路径，可环境变量覆盖
- **VENV_DIR**: Python虚拟环境目录，默认`$ROOT/.venv`
- **SERVER_DIR**: 后端服务目录，默认`$ROOT/server`
- **CLIENT_DIR**: 前端项目目录，默认`$ROOT/client`
- **LOG_DIR**: 日志和PID文件目录，默认`$ROOT/.logs`

### 服务配置
- **BACKEND_HOST**: 后端绑定地址，默认0.0.0.0
- **BACKEND_PORT**: 后端端口，默认8000
- **FRONTEND_PORT**: 前端端口，默认5173
- **PKG_MGR**: 包管理器选择，支持pnpm/yarn/npm/bun

## 关键函数

### choose_env()
**功能**: 交互式环境选择
**流程**:
1. 显示环境选项菜单
2. 用户输入选择(1=dev, 2=test)
3. 设置并导出APP_ENV环境变量
**错误处理**: 无效选择时退出脚本

### load_env_file()
**功能**: 加载环境配置文件
**处理逻辑**:
1. 根据APP_ENV构建配置文件路径`.env.<env>`
2. 使用`set -a`自动导出所有变量
3. source配置文件到当前shell
4. 恢复默认导出设置

### pick_pm()
**功能**: 智能包管理器检测
**优先级**: PKG_MGR环境变量 > pnpm > yarn > npm > bun
**回退**: 如果都不可用，默认使用npm

### running()
**功能**: 检查进程是否运行
**参数**: PID文件路径
**逻辑**: 读取PID文件并使用ps命令验证进程存在

### start_backend()
**功能**: 启动FastAPI后端服务
**特性**:
- **重复启动检测**: 检查PID文件避免重复启动
- **自动重载**: 监控server和rules目录变化
- **排除重载**: 排除.venv、site-packages、__pycache__目录
- **环境文件支持**: 自动加载对应环境的配置文件
- **日志记录**: 输出重定向到backend.log

**uvicorn配置**:
```bash
uvicorn --app-dir server app.main:app 
  --host 0.0.0.0 --port 8000 
  --reload 
  --reload-dir server --reload-dir rules
  --reload-exclude '.venv/*' 
  --reload-exclude '*/site-packages/*' 
  --reload-exclude '**/__pycache__/*'
  --env-file .env.dev
```

### start_frontend()
**功能**: 启动React前端服务
**特性**:
- **package.json检测**: 验证前端项目存在
- **包管理器自适应**: 使用检测到的最佳包管理器
- **重复启动检测**: 防止多重启动
- **端口配置**: 支持自定义前端端口
- **日志记录**: 输出重定向到frontend.log

## 执行流程

### 启动序列
1. **环境选择**: 用户交互选择dev/test环境
2. **环境配置**: 加载对应的.env文件
3. **虚拟环境**: 检测并激活Python虚拟环境
4. **后端启动**: 启动FastAPI服务器
5. **前端启动**: 启动React开发服务器
6. **状态报告**: 显示服务URL和日志路径

### 信息输出
- **环境信息**: 显示当前选择的环境
- **服务地址**: 后端和前端的访问URL
- **日志位置**: 实时日志文件路径
- **监控命令**: 提供tail命令用于查看日志

## 安全特性

### 错误处理
- **set -euo pipefail**: 严格错误处理模式
- **路径验证**: 检查关键目录和文件存在性
- **进程验证**: 启动前检查是否已运行

### 资源管理
- **PID跟踪**: 完整的进程ID管理
- **日志分离**: 前后端日志独立存储
- **目录创建**: 自动创建必要的日志目录

## 开发体验

### 快速启动
- **一键启动**: 单个命令启动完整开发环境
- **智能检测**: 自动检测可用工具和环境
- **状态反馈**: 清晰的启动状态和错误信息

### 灵活配置
- **环境变量覆盖**: 所有配置支持环境变量自定义
- **多包管理器**: 支持主流JavaScript包管理器
- **调试友好**: 详细的日志输出和进程信息

## 使用场景

### 日常开发
- **开发环境启动**: 快速启动完整开发栈
- **环境切换**: 轻松在dev/test环境间切换
- **后台运行**: 长时间开发无需保持终端

### CI/CD集成
- **自动化测试**: 测试前自动启动服务
- **部署验证**: 部署后验证服务状态

这个脚本提供了完整的开发环境管理解决方案，简化了多服务项目的启动流程。