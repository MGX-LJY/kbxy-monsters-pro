# server/app/main.py

## 概述
FastAPI应用程序的主入口文件，负责应用初始化、中间件配置、路由注册和启动逻辑。

## 主要功能

### 应用初始化
- **FastAPI实例创建**: 使用配置中的应用名称创建FastAPI应用
- **CORS配置**: 启用跨域资源共享，允许所有方法和头部
- **中间件**: 添加TraceIDMiddleware用于请求追踪

### 静态文件服务
- **图片挂载**: 挂载怪物图片静态文件服务到`/media/monsters`路径
- **目录管理**: 支持环境变量`MONSTERS_MEDIA_DIR`自定义图片目录
- **默认路径**: 使用`server/images/monsters`作为默认图片存储路径

### 路由注册
**核心路由**:
- `health` - 健康检查接口
- `monsters` - 怪物管理
- `skills` - 技能管理  
- `utils` - 工具接口
- `derive` - 派生功能
- `crawl` - 爬虫功能
- `warehouse` - 仓库管理
- `types` - 属性类型
- `collections` - 收藏管理
- `images` - 图片服务

**可选路由**:
- `tags` - 标签管理（可选）
- `roles` - 角色管理（可选）

### 数据库初始化
- **环境控制**: 仅在dev/test环境执行schema创建
- **竞态保护**: 使用文件锁机制避免uvicorn --reload时的竞态条件
- **错误处理**: 完整的异常捕获和日志记录

### 启动事件处理
- **环境信息记录**: 记录应用环境和数据库路径信息
- **Schema初始化**: 执行数据库表结构创建
- **图片索引预热**: 启动时预热图片解析器索引

### 异常处理
- **HTTP异常**: 统一处理HTTPException，返回标准JSON响应
- **通用异常**: 捕获所有未处理异常，返回500错误

## 技术特点

### 架构设计
- **模块化路由**: 路由按功能模块分离
- **中间件层**: 集中处理请求追踪和CORS
- **静态资源**: 集成静态文件服务

### 开发友好
- **热重载支持**: 通过文件锁机制支持开发时的热重载
- **环境感知**: 根据环境变量调整行为
- **详细日志**: 完整的启动和错误日志记录

### 生产就绪
- **异常处理**: 全局异常捕获和标准化响应
- **资源管理**: 自动创建和管理必要目录
- **可配置性**: 通过环境变量和配置文件控制行为

## 关键配置
- `APP_ENV`: 应用环境（dev/test/prod）
- `MONSTERS_MEDIA_DIR`: 图片文件存储目录
- CORS允许所有来源、方法和头部
- 静态文件挂载到`/media/monsters`路径

这个文件是整个FastAPI应用的核心，负责将所有功能模块整合成一个完整的Web服务。